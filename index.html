<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Interdimensionale</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="tv-container">
        <div class="tv-frame">
            <div class="screen">
                <div class="scanlines"></div>
                <div class="glitch-effect"></div>
                <div id="player"></div>
            </div>
            <div class="channel-info">WAITING FOR SIGNAL...</div>
            <div class="rec-status">
                <span class="rec-dot">REC</span>
                <span class="rec-timer">00:00:00</span>
            </div>
        </div>
        <div class="controls">
            <button id="prevChannel" disabled>Channel -</button>
            <div class="spotify-section">
                <button id="loginButton" class="spotify-button">
                    <span class="spotify-icon">ðŸŽµ</span> Connect with Spotify
                </button>
                <div id="playlistSection" class="hidden">
                    <select id="playlistSelect">
                        <option value="">Select a playlist...</option>
                    </select>
                    <button id="loadButton">Load Playlist</button>
                </div>
            </div>
            <button id="nextChannel" disabled>Channel +</button>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        // Spotify configuration
        const clientId = '7a82dcab533b4f3c8d440bb23f82c6b6';
        const redirectUri = 'https://tvinterdimensionale.vercel.app';

        // Check if we're returning from Spotify auth
        const hash = window.location.hash;
        if (hash) {
            const params = new URLSearchParams(hash.substring(1));
            const accessToken = params.get('access_token');
            if (accessToken) {
                localStorage.setItem('spotify_token', accessToken);
                // Clear the hash
                window.location.hash = '';
                handleAuthentication();
            }
        }

        // UI Elements
        const loginButton = document.getElementById('loginButton');
        const playlistSection = document.getElementById('playlistSection');
        const playlistSelect = document.getElementById('playlistSelect');
        const loadButton = document.getElementById('loadButton');
        const channelInfo = document.querySelector('.channel-info');
        const prevButton = document.getElementById('prevChannel');
        const nextButton = document.getElementById('nextChannel');

        // Event Listeners
        loginButton.addEventListener('click', () => {
            const params = new URLSearchParams({
                client_id: clientId,
                response_type: 'token',
                redirect_uri: redirectUri,
                scope: 'playlist-read-private playlist-read-collaborative',
                show_dialog: true
            });
            window.location.href = `https://accounts.spotify.com/authorize?${params.toString()}`;
        });

        loadButton.addEventListener('click', loadSelectedPlaylist);
        prevButton.addEventListener('click', playPreviousTrack);
        nextButton.addEventListener('click', playNextTrack);

        // Check if already authenticated
        if (localStorage.getItem('spotify_token')) {
            handleAuthentication();
        }

        async function handleAuthentication() {
            loginButton.style.display = 'none';
            playlistSection.classList.remove('hidden');
            await loadPlaylists();
        }

        async function loadPlaylists() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me/playlists', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('spotify_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlists');
                }

                const data = await response.json();
                playlistSelect.innerHTML = '<option value="">Select a playlist...</option>';
                data.items.forEach(playlist => {
                    const option = document.createElement('option');
                    option.value = playlist.id;
                    option.textContent = playlist.name;
                    playlistSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading playlists:', error);
                localStorage.removeItem('spotify_token');
                window.location.reload();
            }
        }

        let currentPlaylist = [];
        let currentTrackIndex = 0;

        async function loadSelectedPlaylist() {
            const playlistId = playlistSelect.value;
            if (!playlistId) return;

            try {
                const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('spotify_token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load playlist');
                }

                const data = await response.json();
                currentPlaylist = data.items.map(item => ({
                    title: item.track.name,
                    artist: item.track.artists[0].name
                }));

                currentTrackIndex = 0;
                prevButton.disabled = false;
                nextButton.disabled = false;
                await playCurrentTrack();
            } catch (error) {
                console.error('Error loading playlist:', error);
                channelInfo.textContent = 'ERROR LOADING PLAYLIST';
            }
        }

        let youtubePlayer;
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('player', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    autoplay: 1,
                    controls: 0,
                    disablekb: 1,
                    fs: 0,
                    modestbranding: 1,
                    rel: 0
                },
                events: {
                    onError: onPlayerError,
                    onStateChange: onPlayerStateChange
                }
            });
        }

        async function searchYouTubeVideo(title, artist) {
            const query = encodeURIComponent(`${title} ${artist} official music video`);
            const response = await fetch(`https://www.googleapis.com/youtube/v3/search?part=id&type=video&q=${query}&key=YOUR_YOUTUBE_API_KEY`);
            const data = await response.json();
            return data.items[0]?.id?.videoId;
        }

        async function playCurrentTrack() {
            const track = currentPlaylist[currentTrackIndex];
            if (!track) return;

            channelInfo.textContent = `CHANNEL ${currentTrackIndex + 1} - ${track.title}`;
            showGlitchEffect();

            try {
                const videoId = await searchYouTubeVideo(track.title, track.artist);
                if (videoId) {
                    youtubePlayer.loadVideoById(videoId);
                } else {
                    channelInfo.textContent = 'VIDEO NOT FOUND';
                }
            } catch (error) {
                console.error('Error playing track:', error);
                channelInfo.textContent = 'PLAYBACK ERROR';
            }
        }

        function playPreviousTrack() {
            if (currentTrackIndex > 0) {
                currentTrackIndex--;
                playCurrentTrack();
            }
        }

        function playNextTrack() {
            if (currentTrackIndex < currentPlaylist.length - 1) {
                currentTrackIndex++;
                playCurrentTrack();
            }
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.ENDED) {
                playNextTrack();
            }
        }

        function onPlayerError(event) {
            console.error('Player error:', event);
            channelInfo.textContent = 'VIDEO PLAYBACK ERROR';
            setTimeout(playNextTrack, 3000);
        }

        function showGlitchEffect() {
            const glitch = document.querySelector('.glitch-effect');
            glitch.classList.add('active');
            setTimeout(() => glitch.classList.remove('active'), 300);
        }

        // Timer
        let recordingTime = 0;
        const recTimer = document.querySelector('.rec-timer');
        setInterval(() => {
            recordingTime++;
            const hours = Math.floor(recordingTime / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((recordingTime % 3600) / 60).toString().padStart(2, '0');
            const seconds = (recordingTime % 60).toString().padStart(2, '0');
            recTimer.textContent = `${hours}:${minutes}:${seconds}`;
        }, 1000);
    </script>
</body>
</html> 